from bs4 import BeautifulSoup
import requests
import datetime
import telebot
from telebot import types
import time

def open_file(filename):
    ids = {}
    with open(filename) as file:
        for i in file.readlines():
            key, val = i.strip().split(';')
            ids[key] = val
    return ids
def get_url(id):
    ids = {}
    with open('venv\ids.txt') as file:
        for i in file.readlines():
            key, val = i.strip().split(';')
            ids[key] = val
    url = ids[str(id)]
    if url.find('?') != -1:
        url = ids[str(id)][:url.find('?')]
    else:
        url = ids[str(id)]
    return url

def parse(url):
    response = requests.get(url)
    response.encoding = 'utf-8'
    soup = BeautifulSoup(response.text, 'lxml')
    page = soup.find_all('li', class_='schedule__day')
    t = [[], [], [], [], [], [], []]
    i = 0
    for day in page:
        date = (day.find('div', class_='schedule__date').text.strip())
        t[i].append('üóìÔ∏è' + date)
        lessons = day.find_all('li', class_='lesson')
        for lesson in lessons:
            t[i].append('üï∞Ô∏è' + lesson.find('div', class_='lesson__subject').text.strip() + ', ' + (
                lesson.find('div', class_='lesson__type').text.strip()))
            t[i].append('üìå' + lesson.find('div', class_='lesson__places').find('div').text.strip() + '\n')
            # t[i].append('')
        i += 1
    return t


while True:
    today = datetime.date.today()
    print(today)
    def file_user_id(uid, number):
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏
        file = open('venv\ids.txt', 'a')
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º
        file.write(str(uid) + ';'+ str(number) +'\n')
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª
        file.close()
    l = []
    dt = datetime.datetime.today()
    client = telebot.TeleBot('5741562885:AAE0B_c2HMWYTNS0HA_c1HnkJE4ttq7vTD4')


    @client.message_handler(commands=['start'])
    def begin(message):
        ids = open_file('venv\ids.txt')
        if str(message.chat.id) not in ids:
            client.send_message(message.chat.id, '–ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–ª—É—á–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø–∏—à–∏ "/reg %—Å—Å—ã–ª–∫–∞_–Ω–∞_—Ç–≤–æ–µ_—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ%"')
        else:
            markup_reply = types.ReplyKeyboardMarkup(resize_keyboard=True)
            btn_1 = types.KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ')
            btn_2 = types.KeyboardButton('–ù–∞—Å—Ç—Ä–æ–π–∫–∏')
            markup_reply.add(btn_1, btn_2)
            client.send_message(message.chat.id, '–ú–µ–Ω—é', reply_markup=markup_reply)

    @client.message_handler(commands=['reg'])
    def register(message):
        ids = open_file('venv\ids.txt')
        if str(message.chat.id) not in ids:
            if 'ruz.spbstu.ru' in message.text:
                file_user_id(message.chat.id, message.text.split()[-1])
                client.send_message(message.chat.id, ' –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
                markup_reply = types.ReplyKeyboardMarkup(resize_keyboard=True)
                btn_1 = types.KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ')
                btn_2 = types.KeyboardButton('–ù–∞—Å—Ç—Ä–æ–π–∫–∏')
                markup_reply.add(btn_1, btn_2)
                client.send_message(message.chat.id, '–ú–µ–Ω—é', reply_markup=markup_reply)
                #client.register_next_step_handler(message, welcome)
            else:
                client.send_message(message.chat.id, '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É')
        else:
            client.send_message(message.chat.id, "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
            markup_reply = types.ReplyKeyboardMarkup(resize_keyboard=True)
            btn_1 = types.KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ')
            btn_2 = types.KeyboardButton('–ù–∞—Å—Ç—Ä–æ–π–∫–∏')
            markup_reply.add(btn_1, btn_2)
            client.send_message(message.chat.id, '–ú–µ–Ω—é', reply_markup=markup_reply)
           # client.register_next_step_handler(message, welcome)

    @client.message_handler(content_types=['text'])
    def get_rasp(message):
        if message.text == '–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ':
            markup_reply = types.ReplyKeyboardMarkup(resize_keyboard=True)
            btn_1 = types.KeyboardButton('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è')
            btn_2 = types.KeyboardButton('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞')
            btn_3 = types.KeyboardButton('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é')
            btn_4 = types.KeyboardButton('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é')
            btn_5 = types.KeyboardButton('–ù–∞–∑–∞–¥')
            markup_reply.add(btn_1, btn_2,btn_3, btn_4, btn_5)
            client.send_message(message.chat.id, '–ù–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å –ø—Ä–∏—Å–ª–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ?', reply_markup=markup_reply)
        if message.text == '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è':
            if today.isoweekday() == 5:
                client.send_message(message.chat.id, "–°–µ–≥–æ–¥–Ω—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ!")
            else:
                t = parse(get_url(message.chat.id))
                res = '\n'.join(t[today.weekday()])
                client.send_message(message.chat.id, res)
        if message.text == '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞':
            if today.isoweekday() == 5:
                client.send_message(message.chat.id, "–ó–∞–≤—Ç—Ä–∞ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ!")
            else:
                t = parse(get_url(message.chat.id))
                res = ' ' * 39 + '\n'.join(t[today.weekday() + 1]) + '\n' +' ' * 39
                client.send_message(message.chat.id, res)
        if message.text == '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é':
            t = parse(get_url(message.chat.id))
            res =''
            for i in t:
                res += '\n'.join(i)
                if i != t[-1] and i != t[-2]:
                    res += '\n\n\n' #+ ' ' * 39 + '\n'
            client.send_message(message.chat.id, res)
        if message.text == '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é':
            if today.isoweekday() == 7:
                nxt = today + datetime.timedelta(days=8)
                nxt_url = get_url(message.chat.id) + f'?date={str(nxt)}'
            else:
                nxt = today + datetime.timedelta(days=7)
                nxt_url = get_url(message.chat.id) + f'?date={str(nxt)}'
            nxt_week = parse(nxt_url)
            res = ''
            for i in nxt_week:
                res += '\n'.join(i)
                if i != nxt_week[-1] and i != nxt_week[-2]:
                    res += '\n\n\n'  # + ' ' * 39 + '\n'
            client.send_message(message.chat.id, res)

        if message.text == '–ù–∞–∑–∞–¥':
            markup_reply = types.ReplyKeyboardMarkup(resize_keyboard=True)
            btn_1 = types.KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ')
            btn_2 = types.KeyboardButton('–ù–∞—Å—Ç—Ä–æ–π–∫–∏')
            markup_reply.add(btn_1, btn_2)
            client.send_message(message.chat.id, '–ú–µ–Ω—é', reply_markup=markup_reply)
        if message.text == '–ù–∞—Å—Ç—Ä–æ–π–∫–∏':
            markup_reply = types.ReplyKeyboardMarkup(resize_keyboard=True)
            btn_1 = types.KeyboardButton('–°–±—Ä–æ—Å–∏—Ç—å —Å—Å—ã–ª–∫—É')
            btn_2 = types.KeyboardButton('–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å')
            btn_3= types.KeyboardButton('–ù–∞–∑–∞–¥')
            markup_reply.add(btn_1, btn_2, btn_3)
            client.send_message(message.chat.id, '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', reply_markup=markup_reply)
        if message.text == '–°–±—Ä–æ—Å–∏—Ç—å —Å—Å—ã–ª–∫—É':
            ids = open_file('venv\ids.txt')
            if str(message.chat.id) in ids:
                ids.pop(str(message.chat.id))
                client.send_message(message.chat.id, '–°—Å—ã–ª–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–∞–Ω–¥—É /reg')
                file = open('venv\ids.txt', 'w')
                for key, value in ids.items():
                    file.write(f'{key};{value}\n')
                file.close()
            else:
                client.send_message(message.chat.id, '–°—Å—ã–ª–∫–∞ —É–∂–µ —Å–±—Ä–æ—à–µ–Ω–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–∞–Ω–¥—É /reg')
    client.polling(none_stop=True, interval=0)
